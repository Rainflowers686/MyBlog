{% extends 'base.html' %}
{% block content %}

<!-- é¡¶éƒ¨ä¸ªäººä¿¡æ¯ Banner -->
<div class="position-relative mb-5" style="margin-top: -30px;">
    <div style="height: 250px; background: {% if user.blog_bg %}url('{{ user.blog_bg.url }}'){% else %}linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%){% endif %} center/cover; border-radius: 0 0 24px 24px;"></div>

    <div class="container position-relative" style="margin-top: -80px;">
        <div class="d-flex align-items-end">
            <!-- å¤´åƒ -->
            <div class="position-relative group">
                <img id="avatarPreview"
                     src="{% if user.avatar %}{{ user.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ user.username }}{% endif %}"
                     class="rounded-circle border border-4 border-white shadow-lg bg-white"
                     width="160" height="160" style="object-fit:cover; transition: 0.3s;">
                <button class="btn btn-dark rounded-circle position-absolute bottom-0 end-0 mb-3 me-2 shadow"
                        onclick="document.getElementById('avatarInput').click()" title="æ›´æ¢å¤´åƒ">
                    <i class="fas fa-camera"></i>
                </button>
            </div>

            <div class="ms-4 mb-3 text-shadow-sm d-none d-md-block">
                <h2 class="fw-bold mb-1">{{ user.first_name|default:user.username }}</h2>
                <p class="mb-0 opacity-75">{{ user.bio|default:"è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™~" }}</p>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <!-- å·¦ä¾§è®¾ç½®å¡ç‰‡ -->
        <div class="col-md-4 mb-4">
            <div class="glass-card animate__animated animate__fadeInUp">
                <h5 class="fw-bold mb-4 border-bottom pb-2"><i class="fas fa-cog text-primary"></i> èµ„æ–™è®¾ç½®</h5>

                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="file" name="avatar" id="avatarInput" class="d-none" accept="image/*" onchange="previewImage(this)">

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">æ˜µç§°</label>
                        <input type="text" name="nickname" value="{{ user.first_name }}" class="form-control border-0 bg-white bg-opacity-50">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">ä¸ªäººç®€ä»‹</label>
                        <textarea name="bio" class="form-control border-0 bg-white bg-opacity-50" rows="2">{{ user.bio }}</textarea>
                    </div>

                    <h6 class="fw-bold mt-4 mb-3 text-info"><i class="fas fa-magic"></i> ä¸ªæ€§åŒ–</h6>

                    <!-- çœ‹æ¿å¨˜å¼€å…³ -->
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">çœ‹æ¿å¨˜</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="show_live2d" id="live2dSwitch" {% if user.show_live2d %}checked{% endif %}>
                            <label class="form-check-label small" for="live2dSwitch">å¼€å¯æ˜¾ç¤º (åˆ·æ–°ç”Ÿæ•ˆ)</label>
                        </div>
                    </div>

                    <!-- ğŸ‘‡ğŸ‘‡ğŸ‘‡ æ‰¾å›ä¸¢å¤±çš„ä¸»é¢˜é€‰æ‹©æ¡† ğŸ‘‡ğŸ‘‡ğŸ‘‡ -->
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">ä¸»é¢˜é£æ ¼</label>
                        <!-- ğŸ‘‡ ä¿®å¤åçš„ä¸»é¢˜é€‰æ‹©æ¡† ğŸ‘‡ -->
                    <!-- ğŸ‘‡ æ›¿æ¢è¿™ä¸€å— ğŸ‘‡ -->
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">ä¸»é¢˜é£æ ¼</label>
                        <select name="theme_color" class="form-select border-0 bg-white bg-opacity-50" style="padding: 12px; border-radius: 12px;">
                            <option value="blue"   {% if user.theme_color == 'blue' %}selected{% endif %}>â˜ï¸ å¤©ç©ºä¹‹åŸ (é»˜è®¤è“)</option>
                            <option value="purple" {% if user.theme_color == 'purple' %}selected{% endif %}>ğŸ”® èµ›åšæœ‹å…‹ (éœ“è™¹ç´«)</option>
                            <option value="dark"   {% if user.theme_color == 'dark' %}selected{% endif %}>ğŸŒ™ æ·±å¤œæ¨¡å¼ (æç®€é»‘)</option>
                            <option value="green"  {% if user.theme_color == 'green' %}selected{% endif %}>ğŸƒ æ£®ä¹‹ç§˜å¢ƒ (æ¸…æ–°ç»¿)</option>
                            <option value="pink"   {% if user.theme_color == 'pink' %}selected{% endif %}>ğŸŒ¸ æ¨±èŠ±çƒ‚æ¼« (æŸ”å’Œç²‰)</option>
                        </select>
                    </div>
                    <!-- ğŸ‘† æ›¿æ¢ç»“æŸ ğŸ‘† -->
                    <!-- ğŸ‘† ä¿®å¤ç»“æŸ ğŸ‘† -->
                            <option value="blue" {% if user.theme_color == 'blue' %}selected{% endif %}>â˜ï¸ å¤©ç©ºä¹‹åŸ (é»˜è®¤)</option>
                            <option value="purple" {% if user.theme_color == 'purple' %}selected{% endif %}>ğŸ”® èµ›åšæœ‹å…‹</option>
                            <option value="dark" {% if user.theme_color == 'dark' %}selected{% endif %}>ğŸŒ™ æ·±å¤œæ¨¡å¼</option>
                            <option value="green" {% if user.theme_color == 'green' %}selected{% endif %}>ğŸƒ æ£®ä¹‹ç§˜å¢ƒ</option>
                            <option value="pink" {% if user.theme_color == 'pink' %}selected{% endif %}>ğŸŒ¸ æ¨±èŠ±çƒ‚æ¼«</option>
                        </select>
                    </div>
                    <!-- ğŸ‘†ğŸ‘†ğŸ‘† æ‰¾å›ç»“æŸ ğŸ‘†ğŸ‘†ğŸ‘† -->

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">åšå®¢æ ‡é¢˜</label>
                        <input type="text" name="blog_title" value="{{ user.blog_title }}" class="form-control border-0 bg-white bg-opacity-50">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">èƒŒæ™¯å›¾</label>
                        <input type="file" name="blog_bg" class="form-control form-control-sm">
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-sky shadow-sm">ä¿å­˜æ›´æ”¹</button>
                        <a href="{% url 'account_change_password' %}" class="btn btn-light text-muted btn-sm rounded-pill">ä¿®æ”¹å¯†ç </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- å³ä¾§æ–‡ç« åˆ—è¡¨ -->
        <div class="col-md-8">
            <div class="glass-card animate__animated animate__fadeInUp animate__delay-1s">
                <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                    <h5 class="fw-bold mb-0"><i class="fas fa-layer-group text-success"></i> æˆ‘çš„æ–‡ç« </h5>
                    <a href="{% url 'create_post' %}" class="btn btn-sm btn-outline-success rounded-pill"><i class="fas fa-plus"></i> æ–°å»º</a>
                </div>

                <div class="list-group list-group-flush">
                    {% for post in user_posts %}
                    <div class="list-group-item bg-transparent border-bottom py-3 px-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <div style="max-width: 70%;">
                                <h6 class="mb-1 fw-bold text-truncate">{{ post.title }}</h6>
                                <div class="small text-muted">
                                    {% if post.is_draft %}<span class="badge bg-warning text-dark me-1">è‰ç¨¿</span>{% endif %}
                                    <i class="far fa-clock"></i> {{ post.created_at|date:"Y/m/d" }}
                                    <span class="mx-1">Â·</span>
                                    <i class="far fa-eye"></i> {{ post.views }}
                                </div>
                            </div>
                            <div>
                                <a href="{% url 'edit_post' post.pk %}" class="btn btn-light btn-sm rounded-circle text-primary shadow-sm"><i class="fas fa-pen"></i></a>
                                <a href="{% url 'delete_post' post.pk %}" onclick="return confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')" class="btn btn-light btn-sm rounded-circle text-danger shadow-sm ms-1"><i class="fas fa-trash"></i></a>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-5 text-muted">ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»åˆ›ä½œå§ï¼</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function previewImage(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) { document.getElementById('avatarPreview').src = e.target.result; }
        reader.readAsDataURL(input.files[0]);
    }
}
</script>
{% endblock %}